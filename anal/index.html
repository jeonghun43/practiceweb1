<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>BTC 인사이트 MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body>
  <main class="wrap">
    <h1>비트코인 관련 지표 빠른 분석</h1>

    <!-- 프리셋 선택 -->
    <section class="controls">
      <label>셋:
        <select id="setSelect">
          <option value="set1">set1 (BTC, 거래량, DXY)</option>
          <option value="set2">set2 (BTC, 트렌드, S&P500)</option>
        </select>
      </label>
      <label>기간:
        <select id="daysSelect">
          <option value="180d" selected>180일</option>
          <option value="90d">90일</option>
          <option value="365d">365일</option>
        </select>
      </label>
      <button id="btnAnalyze">분석 보기</button>
    </section>

    <!-- 요약 -->
    <section>
      <h2>요약</h2>
      <div id="summaryBox" class="summary"></div>
      <small class="note">※ 상관은 인과가 아닙니다. 투자 조언이 아닙니다.</small>
    </section>

    <!-- 라인 차트 -->
    <section>
      <h2>정규화 시계열</h2>
      <canvas id="lineChart"></canvas>
    </section>

    <!-- 산점도 (BTC vs 다른 지표 1개) -->
    <section>
      <h2>산점도 (BTC vs 선택지표)</h2>
      <label>지표 선택:
        <select id="scatterMetric"></select>
      </label>
      <canvas id="scatterChart"></canvas>
    </section>

    <!-- 시차상관 간단 표 -->
    <section>
      <h2>시차 상관(Top 2)</h2>
      <table id="lagTable" class="lag"></table>
    </section>
  </main>

  <script>
    // 상태
    let lineChart, scatterChart, lastData;

    const $ = (sel) => document.querySelector(sel);
    const setSel = $('#setSelect');
    const daysSel = $('#daysSelect');
    const btn = $('#btnAnalyze');
    const sumBox = $('#summaryBox');
    const lagTable = $('#lagTable');
    const scatterSel = $('#scatterMetric');

    btn.addEventListener('click', async () => {
      const setKey = setSel.value;   // e.g., 'set1'
      const days = daysSel.value;    // e.g., '180d'
      const url = `data/${setKey}-${days}.json`;
      const res = await fetch(url);
      const data = await res.json();
      lastData = data;
      renderSummary(data.summary);
      renderLineChart(data.series);
      populateScatterMetric(data.meta.metrics.filter(m => m !== 'btc'));
      renderLagTable(data.lag);
      // 초기 산점도는 첫 지표로
      if (scatterSel.value) renderScatterChart('btc', scatterSel.value, data.series);
    });

    scatterSel.addEventListener('change', () => {
      if (!lastData) return;
      renderScatterChart('btc', scatterSel.value, lastData.series);
    });

    function renderSummary(lines) {
      sumBox.innerHTML = lines.map(l => `<p>${l}</p>`).join('');
    }

    function renderLineChart(series) {
      const labels = series['btc'].map(p => p.date);
      const ds = Object.entries(series).map(([name, rows]) => ({
        label: name,
        data: rows.map(p => p.value),
        borderWidth: 2,
        pointRadius: 0
      }));
      const ctx = document.getElementById('lineChart').getContext('2d');
      if (lineChart) lineChart.destroy();
      lineChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: ds },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function populateScatterMetric(metrics) {
      scatterSel.innerHTML = metrics.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    function renderScatterChart(yMetric, xMetric, series) {
      const y = series[yMetric];
      const x = series[xMetric];
      // 날짜 맞추기(같은 인덱스라고 가정: JSON 생성 시 정렬/동일 길이 유지)
      const points = y.map((p, i) => ({ x: x[i].value, y: p.value }));
      const ctx = document.getElementById('scatterChart').getContext('2d');
      if (scatterChart) scatterChart.destroy();
      scatterChart = new Chart(ctx, {
        type: 'scatter',
        data: { datasets: [{ label: `${yMetric} vs ${xMetric}`, data: points }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: { x: { title: { display: true, text: xMetric } }, y: { title: { display: true, text: yMetric } } }
        }
      });
    }

    function renderLagTable(lagObj) {
      // lagObj 예: { "btc->dxy": {bestLag:-7, corr:-0.46}, ... }
      const rows = Object.entries(lagObj)
        .sort((a,b) => Math.abs(b[1].corr) - Math.abs(a[1].corr))
        .slice(0, 2)
        .map(([k, v]) => `<tr>
          <td>${k}</td><td>${v.bestLag}</td><td>${v.corr.toFixed(2)}</td>
        </tr>`).join('');
      lagTable.innerHTML = `<tr><th>쌍</th><th>최적 시차</th><th>상관</th></tr>${rows}`;
    }

    // 페이지 첫 로드 시 한 번 실행
    btn.click();
  </script>
</body>
</html>
